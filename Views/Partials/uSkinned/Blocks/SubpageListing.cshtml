@inherits UmbracoViewPage<SiteBuilderBlock>
@using USNSiteBuilder.Core.Models
@using USNSiteBuilder.Core.Extensions
@using USNSiteBuilder.Core.Interfaces
@using Umbraco.Cms.Core.Strings
@inject ISiteBuilderService _siteBuilderService
@{
    //Available as Component Block and Split Component Block types

    var content = (IUsn_Cmp_SubpageListing_Content)Model.BlockContent;

    string backgroundColorLabel = ViewData["backgroundColorLabel"].ToString();
    bool disableModalLinks = Convert.ToBoolean(ViewData["disableModalLinks"]);

    //Clear view data before calling next partial
    ViewData.Clear();

    if (content.LinkToListing != null && content.LinkToListing.Any())
    {
        //Intro used for text alignment of tabs
        var intro = (IUsn_Cmp_IntroOutro)Model.BlockContent;

        //Settings taken from compositions common to all block types
        var animateSettings = (IUsn_Cmp_AnimateSettings)Model.BlockSettings;
        var uniqueSettings = (IUsn_Cmp_SubpageListing_Component_Settings)Model.BlockSettings;

        Usnstyle websiteStyle = (Usnstyle)Model.BaseModel.WebsiteStyle;
        UsnglobalSettings globalSettings = (UsnglobalSettings)Model.BaseModel.GlobalSettings;

        string overlayImageClass = uniqueSettings.ItemTextPosition == "item_text-boxed item_overlay" ? _siteBuilderService.GetBackgroundColorClass(uniqueSettings.OverlayBackgroundColor.sortOrder, "content", websiteStyle) : String.Empty;
        backgroundColorLabel = uniqueSettings.ItemTextPosition == "item_text-boxed item_overlay" ? uniqueSettings.OverlayBackgroundColor.label : backgroundColorLabel;
        string itemStyleClass = uniqueSettings.ItemTextPosition.HasValue() ? uniqueSettings.ItemTextPosition : "item_text-below";
        string itemTextAlignment = uniqueSettings.ItemTextAlignment.HasValue() ? uniqueSettings.ItemTextAlignment : "text-left";
        string itemHeadingSizeClass = uniqueSettings.ItemHeadingSize;
        string itemSecondaryHeadingSizeClass = uniqueSettings.ItemSecondaryHeadingSize;
        string listSpacingClass = uniqueSettings.RemoveItemSpacing ? "listing_no-spacing" : String.Empty;
        string tabStyle = uniqueSettings.TabStyle.HasValue() ? uniqueSettings.TabStyle : "tab-basic";
        string verticalAlignmentClass = uniqueSettings.ItemTextPosition == "item_text-boxed item_overlay" ? (uniqueSettings.OverlayTextPosition.HasValue() ? uniqueSettings.OverlayTextPosition.ToString() : "align-self-center") : String.Empty;
        string itemBackgroundClass = uniqueSettings.ItemTextPosition != "item_text-boxed item_overlay" && uniqueSettings.AddBackgroundColor ? "item_has-bg" : String.Empty;
        backgroundColorLabel = uniqueSettings.ItemTextPosition != "item_text-boxed item_overlay" && uniqueSettings.AddBackgroundColor ? uniqueSettings.ItemBackgroundColor.label : backgroundColorLabel;
        string innerBackgroundClass = uniqueSettings.ItemTextPosition != "item_text-boxed item_overlay" && uniqueSettings.AddBackgroundColor ? _siteBuilderService.GetBackgroundColorClass(uniqueSettings.ItemBackgroundColor.sortOrder, "content", websiteStyle) : String.Empty;

        string tabTextAlignment = intro.IntroTextAlignment.HasValue() ? intro.IntroTextAlignment : "justify-content-start text-left";
        ImageSettings imageSettings = _siteBuilderService.GetImageSettings(uniqueSettings.ImageStyle, uniqueSettings.BoxPad);
        AnimationSettings animation = _siteBuilderService.GetAnimationSettings(animateSettings.Animate, animateSettings.AnimationDelay, animateSettings.AnimationDuration, animateSettings.AnimationStyle);

        string uniqueID = Guid.NewGuid().ToString();

        string itemsPerRowValue = String.Empty;

        if (uniqueSettings.ItemTextPosition == "item_text-below" || uniqueSettings.ItemTextPosition == "item_text-above" || uniqueSettings.ItemTextPosition == "item_text-boxed item_overlay")
        {
            itemsPerRowValue = uniqueSettings.ItemsPerRow8;
        }
        else if (uniqueSettings.ItemTextPosition == "item_text-left" || uniqueSettings.ItemTextPosition == "item_text-right")
        {
            itemsPerRowValue = uniqueSettings.ItemsPerRow4;
        }
        else
        {
            itemsPerRowValue = uniqueSettings.ItemsPerRow8;
        }

        CarouselSettings carouselSettings = _siteBuilderService.GetCarouselSettings(false, itemsPerRowValue, uniqueSettings.EnableCarousel, uniqueSettings.AutoRotateSpeed, uniqueSettings.ShowDots, uniqueSettings.ShowArrows);

        int listPage = 0;

        //Get all main pages to display
        List<IPublishedContent> mainPages = new List<IPublishedContent>();
        List<string> tabHeadings = new List<string>();
        List<string> tabIcons = new List<string>();

        if (content.LinkToListing != null && content.LinkToListing.Any())
        {
            foreach (var pageLink in content.LinkToListing)
            {
                if (pageLink.link.LinkType == SiteBuilderLink.UrlPickerTypes.Content && _siteBuilderService.DisplayLink(pageLink, disableModalLinks))
                {
                    var page = Umbraco.Content(pageLink.link.LinkUdi);

                    if (page != null && (page.IsDocumentType(Usnhomepage.ModelTypeAlias) || page.IsDocumentType(Usnpage.ModelTypeAlias) || page.IsDocumentType(UsnblogLandingPage.ModelTypeAlias) || page.IsDocumentType(UsnblogCategoryPage.ModelTypeAlias) || page.IsDocumentType(UsnshopPage.ModelTypeAlias) || page.IsDocumentType(UsnlistingPage.ModelTypeAlias) || page.IsDocumentType(UsnlistingFilterPage.ModelTypeAlias)))
                    {
                        mainPages.Add(page);
                        tabHeadings.Add(pageLink.link.LinkText);
                        tabIcons.Add(pageLink.icon);
                    }
                }
            }
        }

        if (mainPages.Any() && mainPages.Count() > 1)
        {
            <div class="repeatable tabbed @tabStyle @animation.AnimationClass" data-os-animation="@animation.AnimationStyle" data-os-animation-delay="@animation.AnimationDelay" data-os-animation-duration="@animation.AnimationDuration">

                <nav class="tabs">
                    <ul class="nav @tabTextAlignment" role="tablist">
                        @foreach (var item in mainPages)
                        {
                            <li class="tab" role="presentation">
                                <a class="nav-item nav-link nav-button-link @(listPage == 0 ? "active" : "")" id="nav_tab_@(uniqueID)_@listPage" data-bs-toggle="tab" href="#nav_@(uniqueID)_@listPage" role="tab" aria-controls="nav_@(uniqueID)_@listPage" aria-selected="@(listPage == 0 ? "true" : "false")">
                                    @Html.Raw(tabIcons[listPage])@Html.Raw(tabHeadings[listPage])
                                </a>
                            </li>
                            listPage += 1;
                        }
                    </ul>
                </nav>

            </div>
        }

        listPage = 0;

        if (mainPages.Any())
        {
            int pagesToDisplay = uniqueSettings.PagesToDisplay.HasValue() && uniqueSettings.PagesToDisplay != 0 ? uniqueSettings.PagesToDisplay : 10;

            <div class="repeatable-content tab-content">

                @foreach (var landingPage in mainPages)
                {
                    <div id="nav_@(uniqueID)_@listPage" role="tabpanel" aria-labelledby="nav_tab_@(uniqueID)_@listPage" class="tab-pane @(listPage == 0 ? "show active" : String.Empty)">

                        <div class="component-main row @carouselSettings.CarouselRowClass listing @listSpacingClass listing_basic-grid" @Html.Raw(carouselSettings.SlickAttributes)>
                            @if (landingPage.IsDocumentType(Usnhomepage.ModelTypeAlias) || landingPage.IsDocumentType(Usnpage.ModelTypeAlias))
                            {
                                bool hideCurrentPage = uniqueSettings.HideCurrentPageFromList.HasValue() ? uniqueSettings.HideCurrentPageFromList : false;
                                IEnumerable<IPublishedContent> pages;
                                
                                if(hideCurrentPage)
                                {
                                    pages = landingPage.Children.Where(x => (x.IsDocumentType(Usnpage.ModelTypeAlias) || x.IsDocumentType(UsnblogLandingPage.ModelTypeAlias) || x.IsDocumentType(UsnshopPage.ModelTypeAlias) || x.IsDocumentType(UsnlistingPage.ModelTypeAlias) || x.IsDocumentType(UsnsearchResultsPage.ModelTypeAlias)) && x.IsVisible() && x.Id != Model.BaseModel.Id);
                                }
                                else
                                {
                                    pages = landingPage.Children.Where(x => (x.IsDocumentType(Usnpage.ModelTypeAlias) || x.IsDocumentType(UsnblogLandingPage.ModelTypeAlias) || x.IsDocumentType(UsnshopPage.ModelTypeAlias) || x.IsDocumentType(UsnlistingPage.ModelTypeAlias) || x.IsDocumentType(UsnsearchResultsPage.ModelTypeAlias)) && x.IsVisible());
                                }

                                pages = uniqueSettings.EnableRandomOrder ? pages.Randomize() : pages;
                                pages = pages.Take(pagesToDisplay).ToList();
                                
                                foreach (var subPage in pages)
                                {
                                    string pageName = subPage.HasValue("pageListingHeading") ? subPage.Value<string>("pageListingHeading") : subPage.Name;

                                    <div class="item @itemBackgroundClass @carouselSettings.ItemsClass @itemStyleClass @itemTextAlignment @animation.AnimationClass" data-os-animation="@animation.AnimationStyle" data-os-animation-delay="@animation.AnimationDelay" data-os-animation-duration="@animation.AnimationDuration">
                                        <div class="inner @innerBackgroundClass @overlayImageClass @imageSettings.CircleClass">
                                            <a href="@subPage.Url()">
                                                @if (!uniqueSettings.HideImage && subPage.Value<IPublishedContent>("pageListingImage") != null && uniqueSettings.ItemTextPosition != "item_text-above")
                                                {
                                                    <div class="image @overlayImageClass @imageSettings.CircleClass">
                                                        @await Html.PartialAsync(Model.BaseModel.ThemeFolder + "/MiscPageElements/Image", subPage.Value<IPublishedContent>("pageListingImage"), new ViewDataDictionary(ViewData) { { "imageSettings", imageSettings }, { "themeFolder", Model.BaseModel.ThemeFolder } })
                                                    </div>
                                                }
                                                <div class="info @verticalAlignmentClass">

                                                    @if (subPage.HasValue("pageListingSecondaryHeading") && websiteStyle.StyleLayout.headingOrder != "heading-first")
                                                    {
                                                        <p class="secondary-heading @itemSecondaryHeadingSizeClass @(backgroundColorLabel)-secondary-heading">@Html.Raw(subPage.Value<string>("pageListingSecondaryHeading"))</p>
                                                    }

                                                    <p class="heading @itemHeadingSizeClass @(backgroundColorLabel)-heading">@Html.Raw(pageName)</p>

                                                    @if (subPage.HasValue("pageListingSecondaryHeading") && websiteStyle.StyleLayout.headingOrder == "heading-first")
                                                    {
                                                        <p class="secondary-heading @itemSecondaryHeadingSizeClass @(backgroundColorLabel)-secondary-heading">@Html.Raw(subPage.Value<string>("pageListingSecondaryHeading"))</p>
                                                    }

                                                    @if (subPage.HasValue("pageSummary"))
                                                    {
                                                        <div class="text @(backgroundColorLabel)-text">@(subPage.Value<IHtmlEncodedString>("pageSummary"))</div>
                                                    }

                                                </div>
                                                @if (!uniqueSettings.HideImage && subPage.Value<IPublishedContent>("pageListingImage") != null && uniqueSettings.ItemTextPosition == "item_text-above")
                                                {
                                                    <div class="image @overlayImageClass @imageSettings.CircleClass">
                                                        @await Html.PartialAsync(Model.BaseModel.ThemeFolder + "/MiscPageElements/Image", subPage.Value<IPublishedContent>("pageListingImage"), new ViewDataDictionary(ViewData) { { "imageSettings", imageSettings }, { "themeFolder", Model.BaseModel.ThemeFolder } })
                                                    </div>
                                                }
                                            </a>
                                        </div>
                                    </div>
                                }

                            }
                            else if (landingPage.IsDocumentType(UsnblogLandingPage.ModelTypeAlias) || landingPage.IsDocumentType(UsnblogCategoryPage.ModelTypeAlias))
                            {
                                string category = null;
                                IPublishedContent blogLandingPage;

                                if (landingPage.IsDocumentType(UsnblogCategoryPage.ModelTypeAlias))
                                {
                                    category = landingPage.Id.ToString();
                                    blogLandingPage = landingPage.AncestorOrSelf(UsnblogLandingPage.ModelTypeAlias);
                                }
                                else
                                {
                                    blogLandingPage = landingPage;
                                }

                                var blogPages = blogLandingPage.Children.First(x => x.IsDocumentType(UsnblogPostsFolder.ModelTypeAlias)).Children.OrderByDescending(y => y.Value<DateTime>("postDate"));

                                //Filter Blog Posts on Category if required
                                blogPages = category != null && blogPages.Any() ? blogPages.Where(x => x.Value<IEnumerable<IPublishedContent>>("postCategories") != null ? x.Value<IEnumerable<IPublishedContent>>("postCategories").Contains(landingPage) : false).OrderByDescending(y => y.Value<DateTime>("postDate")) : blogPages;

                                //Only get requested number of pages
                                blogPages = pagesToDisplay != -1 && blogPages.Any() ? blogPages.Take(pagesToDisplay).OrderByDescending(y => y.Value<DateTime>("postDate")) : blogPages;

                                if (blogPages.Any())
                                {
                                    var blogPagesOrdered = uniqueSettings.EnableRandomOrder ? blogPages.Randomize() : blogPages;

                                    foreach (var blogPage in blogPagesOrdered)
                                    {
                                        string pageName = blogPage.HasValue("pageListingHeading") ? blogPage.Value<string>("pageListingHeading") : blogPage.Name;

                                        <div class="item item-blog @itemBackgroundClass @carouselSettings.ItemsClass @itemStyleClass @itemTextAlignment @animation.AnimationClass" data-os-animation="@animation.AnimationStyle" data-os-animation-delay="@animation.AnimationDelay" data-os-animation-duration="@animation.AnimationDuration">
                                            <div class="inner @innerBackgroundClass @overlayImageClass @imageSettings.CircleClass">
                                                <a href="@blogPage.Url()">
                                                    @if (!uniqueSettings.HideImage && blogPage.Value<IPublishedContent>("pageListingImage") != null && uniqueSettings.ItemTextPosition != "item_text-above")
                                                    {
                                                        <div class="image @overlayImageClass @imageSettings.CircleClass">
                                                            @await Html.PartialAsync(Model.BaseModel.ThemeFolder + "/MiscPageElements/Image", blogPage.Value<IPublishedContent>("pageListingImage"), new ViewDataDictionary(ViewData) { { "imageSettings", imageSettings }, { "themeFolder", Model.BaseModel.ThemeFolder } })
                                                        </div>
                                                    }
                                                    <div class="info @verticalAlignmentClass">

                                                        @if (blogPage.HasValue("pageListingSecondaryHeading") && websiteStyle.StyleLayout.headingOrder != "heading-first")
                                                        {
                                                            <p class="secondary-heading @itemSecondaryHeadingSizeClass @(backgroundColorLabel)-secondary-heading">@Html.Raw(blogPage.Value<string>("pageListingSecondaryHeading"))</p>
                                                        }

                                                        <p class="heading @itemHeadingSizeClass @(backgroundColorLabel)-heading">@Html.Raw(pageName)</p>

                                                        @if (blogPage.HasValue("pageListingSecondaryHeading") && websiteStyle.StyleLayout.headingOrder == "heading-first")
                                                        {
                                                            <p class="secondary-heading @itemSecondaryHeadingSizeClass @(backgroundColorLabel)-secondary-heading">@Html.Raw(blogPage.Value<string>("pageListingSecondaryHeading"))</p>
                                                        }

                                                        @if (blogPage.HasValue("pageSummary"))
                                                        {
                                                            <div class="text @(backgroundColorLabel)-text">@(blogPage.Value<IHtmlEncodedString>("pageSummary"))</div>
                                                        }

                                                        @if (uniqueSettings.ItemTextPosition == "item_text-boxed item_overlay")
                                                        {
                                                            <!-- Meta -->
                                                            <div class="meta @(backgroundColorLabel)-text">
                                                                <p class="date"><time>@(blogPage.Value<DateTime>("postDate").ToString("dd MMM yyyy"))</time></p>
                                                            </div>
                                                            <!--// Meta -->
                                                        }

                                                    </div>
                                                    @if (!uniqueSettings.HideImage && blogPage.Value<IPublishedContent>("pageListingImage") != null && uniqueSettings.ItemTextPosition == "item_text-above")
                                                    {
                                                        <div class="image @overlayImageClass @imageSettings.CircleClass">
                                                            @await Html.PartialAsync(Model.BaseModel.ThemeFolder + "/MiscPageElements/Image", blogPage.Value<IPublishedContent>("pageListingImage"), new ViewDataDictionary(ViewData) { { "imageSettings", imageSettings }, { "themeFolder", Model.BaseModel.ThemeFolder } })
                                                        </div>
                                                    }
                                                </a>
                                                @if (uniqueSettings.ItemTextPosition != "item_text-boxed item_overlay")
                                                {
                                                    <!-- Meta -->
                                                    <div class="meta @(backgroundColorLabel)-text">
                                                        <p class="date"><time>@(blogPage.Value<DateTime>("postDate").ToString("dd MMM yyyy"))</time></p>
                                                        @await Html.PartialAsync(Model.BaseModel.ThemeFolder + "/Blog/BlogPostCategories", blogPage)
                                                    </div>
                                                    <!--// Meta -->
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                            }
                            else if (landingPage.IsDocumentType(UsnlistingPage.ModelTypeAlias) || (landingPage.IsDocumentType(UsnlistingFilterPage.ModelTypeAlias) && landingPage.Parent.Parent.Parent.IsDocumentType(UsnlistingPage.ModelTypeAlias)))
                            {
                                string category = null;
                                IPublishedContent listingLandingPage;

                                if (landingPage.IsDocumentType(UsnlistingFilterPage.ModelTypeAlias))
                                {
                                    category = landingPage.Id.ToString();
                                    listingLandingPage = landingPage.Parent.Parent.Parent;
                                }
                                else
                                {
                                    listingLandingPage = landingPage;
                                }

                                var listPages = listingLandingPage.Children.First(x => x.IsDocumentType(UsnlistingPagesFolder.ModelTypeAlias)).Children.OrderBy(y => y.SortOrder);

                                //Filter Pages on Category if required
                                listPages = category != null && listPages.Any() ? listPages.Where(x => x.Value<IEnumerable<IPublishedContent>>("filters") != null ? x.Value<IEnumerable<IPublishedContent>>("filters").Contains(landingPage) : false).OrderBy(y => y.SortOrder) : listPages;

                                //Only get requested number of pages
                                listPages = pagesToDisplay != -1 && listPages.Any() ? listPages.Take(pagesToDisplay).OrderBy(y => y.SortOrder) : listPages;

                                if (listPages.Any())
                                {
                                    var listPagesOrdered = uniqueSettings.EnableRandomOrder ? listPages.Randomize() : listPages;

                                    foreach (var subPage in listPagesOrdered)
                                    {
                                        string pageName = subPage.HasValue("pageListingHeading") ? subPage.Value<string>("pageListingHeading") : subPage.Name;

                                        <div class="item @itemBackgroundClass @carouselSettings.ItemsClass @itemStyleClass @itemTextAlignment @animation.AnimationClass" data-os-animation="@animation.AnimationStyle" data-os-animation-delay="@animation.AnimationDelay" data-os-animation-duration="@animation.AnimationDuration">
                                            <div class="inner @innerBackgroundClass @overlayImageClass @imageSettings.CircleClass">
                                                <a href="@subPage.Url()">
                                                    @if (!uniqueSettings.HideImage && subPage.Value<IPublishedContent>("pageListingImage") != null && uniqueSettings.ItemTextPosition != "item_text-above")
                                                    {
                                                        <div class="image @overlayImageClass @imageSettings.CircleClass">
                                                            @await Html.PartialAsync(Model.BaseModel.ThemeFolder + "/MiscPageElements/Image", subPage.Value<IPublishedContent>("pageListingImage"), new ViewDataDictionary(ViewData) { { "imageSettings", imageSettings }, { "themeFolder", Model.BaseModel.ThemeFolder } })
                                                        </div>
                                                    }
                                                    <div class="info @verticalAlignmentClass">

                                                        @if (subPage.HasValue("pageListingSecondaryHeading") && websiteStyle.StyleLayout.headingOrder != "heading-first")
                                                        {
                                                            <p class="secondary-heading @itemSecondaryHeadingSizeClass @(backgroundColorLabel)-secondary-heading">@Html.Raw(subPage.Value<string>("pageListingSecondaryHeading"))</p>
                                                        }

                                                        <p class="heading @itemHeadingSizeClass @(backgroundColorLabel)-heading">@Html.Raw(pageName)</p>

                                                        @if (subPage.HasValue("pageListingSecondaryHeading") && websiteStyle.StyleLayout.headingOrder == "heading-first")
                                                        {
                                                            <p class="secondary-heading @itemSecondaryHeadingSizeClass @(backgroundColorLabel)-secondary-heading">@Html.Raw(subPage.Value<string>("pageListingSecondaryHeading"))</p>
                                                        }

                                                        @if (subPage.HasValue("pageSummary"))
                                                        {
                                                            <div class="text @(backgroundColorLabel)-text">@(
                                                         subPage.Value<IHtmlEncodedString>("pageSummary")
                                                         )</div>
                                                        }

                                                    </div>
                                                    @if (!uniqueSettings.HideImage && subPage.Value<IPublishedContent>("pageListingImage") != null && uniqueSettings.ItemTextPosition == "item_text-above")
                                                    {
                                                        <div class="image @overlayImageClass @imageSettings.CircleClass">
                                                            @await Html.PartialAsync(Model.BaseModel.ThemeFolder + "/MiscPageElements/Image", subPage.Value<IPublishedContent>("pageListingImage"), new ViewDataDictionary(ViewData) { { "imageSettings", imageSettings }, { "themeFolder", Model.BaseModel.ThemeFolder } })
                                                        </div>
                                                    }
                                                </a>
                                            </div>
                                        </div>
                                    }
                                }

                            }
                            else if (landingPage.IsDocumentType(UsnshopPage.ModelTypeAlias) || (landingPage.IsDocumentType(UsnlistingFilterPage.ModelTypeAlias) && landingPage.Parent.Parent.Parent.IsDocumentType(UsnshopPage.ModelTypeAlias)))
                            {
                                string category = null;
                                IPublishedContent shopLandingPage;

                                if (landingPage.IsDocumentType(UsnlistingFilterPage.ModelTypeAlias))
                                {
                                    category = landingPage.Id.ToString();
                                    shopLandingPage = landingPage.Parent.Parent.Parent;
                                }
                                else
                                {
                                    shopLandingPage = landingPage;
                                }

                                var productPages = shopLandingPage.Children.First(x => x.IsDocumentType(UsnproductPagesFolder.ModelTypeAlias)).Children.OrderBy(y => y.SortOrder);

                                //Filter Pages on Category if required
                                productPages = category != null && productPages.Any() ? productPages.Where(x => x.Value<IEnumerable<IPublishedContent>>("filters") != null ? x.Value<IEnumerable<IPublishedContent>>("filters").Contains(landingPage) : false).OrderBy(y => y.SortOrder) : productPages;

                                //Only get requested number of pages
                                productPages = pagesToDisplay != -1 && productPages.Any() ? productPages.Take(pagesToDisplay).OrderBy(y => y.SortOrder) : productPages;

                                if (productPages.Any())
                                {
                                    var productPagesOrdered = uniqueSettings.EnableRandomOrder ? productPages.Randomize() : productPages;

                                    foreach (UsnproductPage productPage in productPagesOrdered)
                                    {
                                        string pageName = productPage.PageListingHeading.HasValue() ? productPage.PageListingHeading : productPage.Name;

                                        <div class="item @itemBackgroundClass @carouselSettings.ItemsClass @itemStyleClass @itemTextAlignment @animation.AnimationClass" data-os-animation="@animation.AnimationStyle" data-os-animation-delay="@animation.AnimationDelay" data-os-animation-duration="@animation.AnimationDuration">
                                            <div class="inner @innerBackgroundClass @overlayImageClass @imageSettings.CircleClass">
                                                @if (!globalSettings.DisplayProductCta)
                                                {
                                                    @:<a href="@productPage.Url()">
                                                }
                                                @if (!uniqueSettings.HideImage && productPage.PageListingImage.HasValue() && uniqueSettings.ItemTextPosition != "item_text-above")
                                                {
                                                    <div class="image @overlayImageClass @imageSettings.CircleClass">
                                                        @await Html.PartialAsync(Model.BaseModel.ThemeFolder + "/MiscPageElements/Image", productPage.PageListingImage, new ViewDataDictionary(ViewData) { { "imageSettings", imageSettings }, { "themeFolder", Model.BaseModel.ThemeFolder } })
                                                    </div>
                                                }
                                                <div class="info @verticalAlignmentClass">

                                                    @if (productPage.PageListingSecondaryHeading.HasValue() && websiteStyle.StyleLayout.headingOrder != "heading-first")
                                                    {
                                                        <p class="secondary-heading @itemSecondaryHeadingSizeClass @(backgroundColorLabel)-secondary-heading">@Html.Raw(productPage.PageListingSecondaryHeading)</p>
                                                    }

                                                    <p class="heading @itemHeadingSizeClass @(backgroundColorLabel)-heading">@Html.Raw(pageName)</p>

                                                    @if (productPage.PageListingSecondaryHeading.HasValue() && websiteStyle.StyleLayout.headingOrder == "heading-first")
                                                    {
                                                        <p class="secondary-heading @itemSecondaryHeadingSizeClass @(backgroundColorLabel)-secondary-heading">@Html.Raw(productPage.PageListingSecondaryHeading)</p>
                                                    }

                                                    @if (productPage.PageSummary.HasValue())
                                                    {
                                                        <div class="text @(backgroundColorLabel)-text">@Html.Raw(productPage.PageSummary)</div>
                                                    }

                                                    @if (productPage.CurrentPrice.HasValue() || productPage.PreviousPrice.HasValue())
                                                    {
                                                        <p class="price">
                                                            @if (productPage.CurrentPrice.HasValue() && !productPage.PreviousPrice.HasValue())
                                                            {
                                                                <span class="standard @(backgroundColorLabel)-text">@Html.Raw(_siteBuilderService.GetPriceFormat(productPage.Id, globalSettings.CurrencyFormat,  globalSettings.CurrencySymbol,productPage.CurrentPrice, false ))</span>
                                                            }
                                                            else if (productPage.CurrentPrice.HasValue() && productPage.PreviousPrice.HasValue())
                                                            {
                                                                <span class="now @(backgroundColorLabel)-heading">@Html.Raw(_siteBuilderService.GetPriceFormat(productPage.Id, globalSettings.CurrencyFormat,  globalSettings.CurrencySymbol,productPage.CurrentPrice, false ))</span>
                                                            }
                                                            @if (productPage.PreviousPrice.HasValue())
                                                            {
                                                                <span class="was @(backgroundColorLabel)-text">@Html.Raw(_siteBuilderService.GetPriceFormat(productPage.Id, globalSettings.CurrencyFormat,  globalSettings.CurrencySymbol,productPage.PreviousPrice, false ))</span>
                                                            }
                                                        </p>
                                                    }
                                                    @if (globalSettings.DisplayProductCta)
                                                    {
                                                        <!-- Link -->
                                                        <p class="link">

                                                            @if (productPage.UseAlternativeProductUrl && productPage.AlternativeProductUrl.HasValue() && _siteBuilderService.DisplayLink(productPage.AlternativeProductUrl, false))
                                                            {
                                                                <a class="btn base-btn-bg base-btn-bg-solid base-btn-bg-hover-solid base-btn-text base-btn-borders" href="@(productPage.AlternativeProductUrl.link.LinkUrl)" @Html.Raw(productPage.AlternativeProductUrl.rel) @Html.Raw(productPage.AlternativeProductUrl.link.LinkTarget) @Html.Raw(productPage.AlternativeProductUrl.link.LinkTitle)>
                                                                    <span></span>
                                                                    @Html.Raw(productPage.AlternativeProductUrl.icon)@Html.Raw(productPage.AlternativeProductUrl.link.LinkText)@Html.Raw(productPage.AlternativeProductUrl.link.LinkTargetIcon)
                                                                </a>

                                                            }
                                                            else if (!productPage.UseAlternativeProductUrl && globalSettings.Shop == "snipcart" && !globalSettings.SnipcartGlobal.snipcartApiKey.IsNullOrWhiteSpace() && productPage.CurrentPrice.HasValue())
                                                            {
                                                                <!-- Add to cart -->
                                                                <button id="snpbtn-list-@Model.BlockContent.Key.ToString().Replace("-", "_")-@productPage.Id" role="button" @Html.Raw(_siteBuilderService.BuildSnipcartProductDefinition(productPage)) class="btn base-btn-bg base-btn-bg-solid base-btn-bg-hover-solid base-btn-text base-btn-borders snipcart-add-item snpbtn-@productPage.Id">
                                                                    <span></span>
                                                                    @Umbraco.GetDictionaryValue("USN Shop Add to Cart")
                                                                </button>
                                                                <!--// Add to cart -->
                                                            }

                                                            <!-- More info link -->
                                                            <a class="link_non-btn" href="@productPage.Url()">@Umbraco.GetDictionaryValue("USN Shop Product Detail Link")</a>
                                                            <!--// More info link -->

                                                        </p>
                                                        <!--// Link -->
                                                    }
                                                </div>
                                                @if (!uniqueSettings.HideImage && productPage.PageListingImage.HasValue() && uniqueSettings.ItemTextPosition == "item_text-above")
                                                {
                                                    <div class="image @overlayImageClass @imageSettings.CircleClass">
                                                        @await Html.PartialAsync(Model.BaseModel.ThemeFolder + "/MiscPageElements/Image", productPage.PageListingImage, new ViewDataDictionary(ViewData) { { "imageSettings", imageSettings }, { "themeFolder", Model.BaseModel.ThemeFolder } })
                                                    </div>
                                                }

                                                @if (productPage.Labels.Any())
                                                {
                                                    <!-- Labels -->
                                                    <div class="labels">
                                                        @foreach (var label in productPage.Labels)
                                                        {
                                                            var labelContent = (Usn_Cbi_LabelItem)label.Content;

                                                            <span class="label item-label @labelContent.Color.label-label-bg  @labelContent.Color.label-label-text">@labelContent.Label</span>
                                                        }

                                                    </div>
                                                    <!-- Labels -->
                                                }

                                                @if (!globalSettings.DisplayProductCta)
                                                {
                                                    @:</a>
                                                }
                                            </div>
                                        </div>
                                    }
                                }

                            }
                        </div>

                    </div>

                    listPage += 1;

                }

            </div>
        }
    }

}